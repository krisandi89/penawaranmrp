<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quotation Generator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f0f2f5; }
        .modal { display: none; }
        .modal.active { display: flex; }
        #pdf-preview-modal { position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.8); }
        #preview-container { padding: 2rem 0; }
        .page { font-family: 'Arial', sans-serif !important; background-color: white; box-shadow: 0 4px 12px rgba(0,0,0,0.4); width: 21cm; height: 29.7cm; margin: 0 auto 1.5rem auto; position: relative; overflow: hidden; page-break-after: always; }
        .page:last-child { page-break-after: auto; }
        .page-header-img { position: absolute; top: 0; left: 0; width: 100%; height: auto; }
        .page-content-wrapper { position: absolute; top: 4.2cm; bottom: 2.5cm; left: 2.5cm; right: 2cm; font-size: 10pt !important; line-height: 1.5 !important; }
        .page-content-inner table { width: 100%; border-collapse: collapse; }
        .page-content-inner th, .page-content-inner td { border: 1px solid #333; padding: 5px; vertical-align: top; }
        .page-content-inner th { background-color: #e9e9e9; }
        #toast-notification.show { transform: translateY(0); opacity: 1; }
        @media print {
            body * { visibility: hidden; }
            #preview-container, #preview-container * { visibility: visible; }
            #preview-container { position: absolute; left: 0; top: 0; width: 100%; padding: 0; }
            .page { margin: 0; box-shadow: none; border: none; }
            #form-container, #header, #modal-controls { display: none; }
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <div id="app" class="container mx-auto p-4 md:p-8">

        <!-- Header -->
        <header class="mb-8">
            <h1 class="text-4xl font-bold text-gray-800">Quotation Generator</h1>
            <p class="text-gray-600">Buat, kelola, dan unduh surat penawaran harga dengan mudah.</p>
        </header>

        <!-- Main Content -->
        <main id="main-view">
            <div class="bg-white p-6 rounded-xl shadow-md">
                <div class="flex flex-wrap gap-4 justify-between items-center mb-4">
                    <h2 class="text-2xl font-semibold">Daftar Penawaran</h2>
                    <button onclick="app.showForm()" class="bg-blue-600 text-white font-semibold px-5 py-2 rounded-lg hover:bg-blue-700 shadow-sm">+ Buat Penawaran Baru</button>
                </div>
                <div id="quotation-list" class="space-y-3"></div>
            </div>
        </main>

        <!-- Form View -->
        <div id="form-view" class="hidden">
            <div class="bg-white p-6 rounded-xl shadow-md">
                <div class="flex justify-between items-center mb-6">
                    <h2 id="form-title" class="text-2xl font-semibold">Buat Penawaran Baru</h2>
                    <button onclick="app.showList()" class="bg-gray-200 text-gray-800 font-semibold px-5 py-2 rounded-lg hover:bg-gray-300">&larr; Kembali ke Daftar</button>
                </div>

                <form id="quotation-form" class="space-y-6">
                    <input type="hidden" id="quotation-id">
                    <fieldset class="border p-4 rounded-lg">
                        <legend class="text-lg font-semibold px-2">Informasi Dasar</legend>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-x-6 gap-y-4">
                            <div class="md:col-span-2 grid grid-cols-1 md:grid-cols-2 gap-x-6 gap-y-4 border p-4 rounded-md bg-gray-50/50">
                                <h3 class="md:col-span-2 text-md font-semibold text-gray-600 -mt-1 mb-1">Data Pelanggan</h3>
                                <div class="md:col-span-2"><label for="customer-name" class="block text-sm font-medium text-gray-700">Nama Pelanggan / Perusahaan</label><input type="text" id="customer-name" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm" placeholder="Contoh: PT Konstruksi Jaya"></div>
                                <div class="md:col-span-2"><label for="customer-address" class="block text-sm font-medium text-gray-700">Alamat Pelanggan</label><textarea id="customer-address" rows="2" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm" placeholder="Jl. Contoh Alamat No. 123, Jakarta"></textarea></div>
                                <div class="md:col-span-2"><label for="customer-phone" class="block text-sm font-medium text-gray-700">Telepon / UP</label><input type="text" id="customer-phone" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm" placeholder="Up: Bapak Budi (0812-3456-7890)"></div>
                            </div>
                            <div><label for="project-name" class="block text-sm font-medium text-gray-700">Nama Proyek</label><input type="text" id="project-name" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm"></div>
                            <div><label for="quotation-date" class="block text-sm font-medium text-gray-700">Tanggal Penawaran</label><input type="date" id="quotation-date" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm"></div>
                            <div><label for="valid-until-date" class="block text-sm font-medium text-gray-700">Berlaku Hingga</label><input type="date" id="valid-until-date" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm"></div>
                            <div><label for="marketing-id" class="block text-sm font-medium text-gray-700">Marketing</label><select id="marketing-id" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm"></select></div>
                            <div class="md:col-span-2"><label for="quotation-number" class="block text-sm font-medium text-gray-700">Nomor Surat</label><input type="text" id="quotation-number" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm bg-gray-100" readonly></div>
                        </div>
                    </fieldset>

                    <fieldset class="border p-4 rounded-lg">
                        <legend class="text-lg font-semibold px-2">Item Penawaran</legend>
                        <div class="flex flex-wrap items-center gap-4 mb-4">
                            <select id="product-selector" class="block flex-grow p-2 border border-gray-300 rounded-md shadow-sm"></select>
                            <button type="button" onclick="app.addItem()" class="bg-green-600 text-white font-semibold px-4 py-2 rounded-lg hover:bg-green-700 whitespace-nowrap">+ Tambah Item</button>
                            <button type="button" onclick="app.showCustomItemModal()" class="bg-sky-600 text-white font-semibold px-4 py-2 rounded-lg hover:bg-sky-700 whitespace-nowrap">+ Tambah Item Kustom</button>
                            <button type="button" onclick="app.showProductManager()" class="bg-gray-600 text-white font-semibold px-4 py-2 rounded-lg hover:bg-gray-700">Kelola Daftar Item</button>
                        </div>
                        <div id="item-list" class="space-y-2"></div>
                        <div class="mt-4 flex justify-between items-center">
                            <div class="flex items-center"><input type="checkbox" id="show-total" class="h-4 w-4 rounded border-gray-300 text-blue-600" checked><label for="show-total" class="ml-2 block text-sm text-gray-900">Tampilkan Total Harga di PDF?</label></div>
                            <p class="text-xl font-bold">Total: <span id="total-amount">Rp 0</span></p>
                        </div>
                    </fieldset>

                    <fieldset class="border p-4 rounded-lg">
                        <legend class="text-lg font-semibold px-2">Kondisi & Pembayaran</legend>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div><label for="conditions" class="block text-sm font-medium text-gray-700">Kondisi Penawaran</label><textarea id="conditions" rows="8" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm"></textarea></div>
                            <div><label for="payment-method" class="block text-sm font-medium text-gray-700">Metode Pembayaran</label><textarea id="payment-method" rows="8" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm"></textarea></div>
                        </div>
                    </fieldset>

                    <div class="flex justify-end gap-4 pt-4">
                        <button type="button" onclick="app.saveQuotation()" class="bg-blue-600 text-white font-bold px-6 py-3 rounded-lg hover:bg-blue-700 shadow-sm">Simpan Penawaran</button>
                        <button type="button" onclick="app.showPDFPreview()" class="bg-teal-600 text-white font-bold px-6 py-3 rounded-lg hover:bg-teal-700 shadow-sm">Pratinjau PDF</button>
                    </div>
                </form>
            </div>
        </div>
        
        <div id="pdf-preview-modal" class="modal">
            <div class="fixed top-0 left-0 right-0 bg-white p-3 text-center z-20 shadow-lg" id="modal-controls">
                <button onclick="document.getElementById('pdf-preview-modal').classList.remove('active')" class="bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-lg mr-4">Tutup Pratinjau</button>
                <button onclick="app.downloadPDF()" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg">Unduh PDF</button>
            </div>
            <div id="preview-container" class="w-full h-full"></div>
        </div>
        
        <div id="custom-item-modal" class="modal fixed inset-0 bg-black bg-opacity-50 justify-center items-center p-4 z-50">
            <div class="bg-white rounded-lg shadow-xl w-full max-w-md flex flex-col">
                <div class="p-4 border-b"><h3 id="custom-item-title" class="text-xl font-semibold">Tambah Item Kustom</h3><input type="hidden" id="custom-item-id"></div>
                <div class="p-4 space-y-4">
                    <div><label for="custom-item-name" class="block text-sm font-medium">Nama Item</label><input type="text" id="custom-item-name" class="mt-1 w-full p-2 border rounded-md"></div>
                    <div><label for="custom-item-desc" class="block text-sm font-medium">Deskripsi</label><textarea id="custom-item-desc" rows="2" class="mt-1 w-full p-2 border rounded-md"></textarea></div>
                    <div class="grid grid-cols-2 gap-4">
                         <div><label for="custom-item-unit" class="block text-sm font-medium">Satuan</label><input type="text" id="custom-item-unit" class="mt-1 w-full p-2 border rounded-md" placeholder="e.g., m², ls, roll"></div>
                         <div><label for="custom-item-price" class="block text-sm font-medium">Harga Satuan</label><input type="number" id="custom-item-price" class="mt-1 w-full p-2 border rounded-md" placeholder="e.g., 25000"></div>
                    </div>
                </div>
                <div class="p-4 bg-gray-50 flex justify-end gap-3">
                    <button onclick="document.getElementById('custom-item-modal').classList.remove('active')" class="bg-gray-200 text-gray-800 font-semibold px-5 py-2 rounded-lg hover:bg-gray-300">Batal</button>
                    <button onclick="app.addOrUpdateCustomItem()" class="bg-blue-600 text-white font-semibold px-5 py-2 rounded-lg hover:bg-blue-700">Simpan Item</button>
                </div>
            </div>
        </div>

        <div id="product-manager-modal" class="modal fixed inset-0 bg-black bg-opacity-50 justify-center items-center p-4 z-50">
            <div class="bg-white rounded-lg shadow-xl w-full max-w-lg flex flex-col">
                <div class="p-4 border-b flex justify-between items-center"><h3 class="text-xl font-semibold">Kelola Daftar Item</h3><button onclick="document.getElementById('product-manager-modal').classList.remove('active')" class="text-gray-500 hover:text-gray-800 text-2xl font-bold">&times;</button></div>
                <div id="product-manager-list" class="p-4 space-y-2 max-h-[60vh] overflow-y-auto"></div>
            </div>
        </div>

        <div id="toast-notification" class="fixed bottom-5 right-5 bg-gray-800 text-white py-3 px-5 rounded-lg shadow-lg transform translate-y-20 opacity-0 transition-all duration-300"><p id="toast-message"></p></div>
    </div>

    <script>
        const app = {
            db: {
                initialProducts: [
                    { id: 1, name: 'GEOMEMBRANE HDPE', description: 'Merk: HUITEX 20 MIL\nKetebalan: 0,50mm\nDimensi Roll: 7m x 420m', unit: 'm²', price: 25000 },
                    { id: 2, name: 'Instalasi Geomembrane', description: '', unit: 'LS', price: 38000000 },
                    { id: 3, name: 'GEOTEXTILE NON-WOVEN', description: 'Merk: MULTITEX\nTipe: 200gr/m²', unit: 'm²', price: 8000 },
                    { id: 4, name: 'Biaya Angkut', description: '1 Truk (Max. 7 Roll)', unit: 'Truk', price: 26000000 }
                ],
                marketing: [
                    { id: 1, name: 'Ir. Krisandi Saptyanto', title: 'Design and Project Manager', phone: '+62-821-1012-8965', signatureImg: 'data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAyMDAgODAiPjxzdHlsZT4uc3Ryb2tlIHtzdHJva2U6IzAwMDtmaWxsOm5vbmU7c3Ryb2tlLXdpZHRoOjI7c3Ryb2tlLWxpbmVjYXA6cm91bmQ7c3Ryb2tlLWxpbmVqb2luOnJvdW5kO308L3N0eWxlPjxwYXRoIGNsYXNzPSJzdHJva2UiIGQ9Ik0xMCw1MEMxNSwzMCwzMCwxMCw1MCwyMGMxNSw4LDQwLTUsNTAtNWMxNSwwLDMwLDE1LDQwLDQwIEMxODAsNTUsMTgwLDMwLDE5MCw0MCIvPjxwYXRoIGNsYXNzPSJzdHJva2UiIGQ9Ik04MCw0MEw5MCw1MEwxMDAsNDBMMTEwLDUwIi8+PC9zdmc+' },
                    { id: 2, name: 'Ir. Isparmo, IPM', title: 'Marketing Manager', phone: '0812 108 3060', signatureImg: 'data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAyMDAgODAiPjxzdHlsZT4uc3Ryb2tlIHtzdHJva2U6IzAwMDtmaWxsOm5vbmU7c3Ryb2tlLXdpZHRoOjI7c3Ryb2tlLWxpbmVjYXA6cm91bmQ7c3Ryb2tlLWxpbmVqb2luOnJvdW5kO308L3N0eWxlPjxwYXRoIGNsYXNzPSJzdHJva2UiIGQ9Ik0xMiw0OEMyMCwzNSwzNSwxNSw1NSwyNWMxOCw4LDM1LTIsNDUtMWMxMiwyLDMwLDEwLDQwLDMwIEMxNzAsNTAsMTc1LDMwLDE4OCw0MiIvPjwvc3ZnPg==' },
                    { id: 3, name: 'Ir. Nuruzzaman', title: 'Technical & Marketing Manager', phone: '0811-877-022', signatureImg: 'data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAyMDAgODAiPjxzdHlsZT4uc3Ryb2tlIHtzdHJva2U6IzAwMDtmaWxsOm5vbmU7c3Ryb2tlLXdpZHRoOjI7c3Ryb2tlLWxpbmVjYXA6cm91bmQ7c3Ryb2tlLWxpbmVqb2luOnJvdW5kO308L3N0eWxlPjxwYXRoIGNsYXNzPSJzdHJva2UiIGQ9Ik0xNSw1MEMyMCwzMCw0MCwxMCw2MCwyMGMxOCw4LDM4LTUsNDgtNWMxMiwwLDM1LDE1LDQ1LDQwIEMxODAsNTUsMTg1LDMwLDE5MCw0NCIvPjwvc3ZnPg==' },
                    { id: 4, name: 'Ir. Astri Juwita P.', title: 'Design & Product Manager', phone: '+62-812-9876-5432', signatureImg: 'data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAyMDAgODAiPjxzdHlsZT4uc3Ryb2tlIHtzdHJva2U6IzAwMDtmaWxsOm5vbmU7c3Ryb2tlLXdpZHRoOjI7c3Ryb2tlLWxpbmVjYXA6cm91bmQ7c3Ryb2tlLWxpbmVqb2luOnJvdW5kO308L3N0eWxlPjxwYXRoIGNsYXNzPSJzdHJva2UiIGQ9Ik0xMCw1NUMyNSwzNSw0NSwxNSw2NSwyMmMxOCw2LDQwLTgsNTAtMTBjMTUsLTMsMjUsMTgsMzUsNDIgQzE4MCw1MCwxODIsMzIsMTkwLDQxIi8+PC9zdmc+' }
                ],
                defaultConditions: `• Harga Material Locco Gudang Multibangun di Bitung, Tangerang.\n• Harga Material dan Instalasi belum termasuk PPN 11%.\n• Harga Instalasi tidak termasuk genset 10 kVA & dewatering pump.\n• Harga Instalasi tidak termasuk persiapan lahan dan pekerjaan tanah seperti penggalian, penimbunan dan pembuatan angkur.\n• Harga Instalasi tidak termasuk Unskilled labor (kuli gelar) dan besi angkur.\n• Harga Instalasi tidak termasuk peralatan tambahan seperti plat strip, baut, dll bila diperlukan.\n• Harga Instalasi tidak termasuk biaya langsir Material.\n• Harga Instalasi sudah termasuk akomodasi, transportasi, penginapan dan tes kesehatan untuk installer.\n• Harga Instalasi dengan asumsi pekerjaan dilakukan bukan pada musim hujan.`,
                defaultPaymentMethod: `• Material: Cash in Advance.\n• Instalasi: DP 50%, sisa pelunasan sesuai dengan prosentase progress pekerjaan secara bertahap.\n• Pengambilan Material setelah Purchase Order dan pembayaran diterima.\n• Material Ready Stock.`
            },
            state: { quotations: [], products: [], currentQuotationItems: [] },
            init() { this.loadFromLocalStorage(); this.populateDropdowns(); this.renderQuotationList(); this.showList(); },
            showList() { document.getElementById('main-view').classList.remove('hidden'); document.getElementById('form-view').classList.add('hidden'); this.renderQuotationList(); },
            showForm(id = null) {
                document.getElementById('main-view').classList.add('hidden');
                document.getElementById('form-view').classList.remove('hidden');
                this.resetForm();
                if (id !== null) {
                    document.getElementById('form-title').innerText = 'Edit Penawaran';
                    const q = this.state.quotations.find(q => q.id === id);
                    if (q) {
                        document.getElementById('quotation-id').value = q.id;
                        document.getElementById('customer-name').value = q.customer.name;
                        document.getElementById('customer-address').value = q.customer.address;
                        document.getElementById('customer-phone').value = q.customer.phone;
                        document.getElementById('marketing-id').value = q.marketingId;
                        document.getElementById('project-name').value = q.projectName;
                        document.getElementById('quotation-date').value = q.date;
                        document.getElementById('quotation-number').value = q.number;
                        document.getElementById('valid-until-date').value = q.validUntil;
                        document.getElementById('conditions').value = q.conditions;
                        document.getElementById('payment-method').value = q.paymentMethod;
                        document.getElementById('show-total').checked = q.showTotal;
                        this.state.currentQuotationItems = JSON.parse(JSON.stringify(q.items));
                    }
                } else {
                    document.getElementById('form-title').innerText = 'Buat Penawaran Baru';
                    const today = new Date();
                    document.getElementById('quotation-date').value = today.toISOString().split('T')[0];
                    today.setDate(today.getDate() + 14);
                    document.getElementById('valid-until-date').value = today.toISOString().split('T')[0];
                    document.getElementById('quotation-number').value = this.generateQuotationNumber();
                    document.getElementById('conditions').value = this.db.defaultConditions;
                    document.getElementById('payment-method').value = this.db.defaultPaymentMethod;
                }
                this.renderItems();
            },
            resetForm() { document.getElementById('quotation-form').reset(); document.getElementById('quotation-id').value = ''; this.state.currentQuotationItems = []; this.renderItems(); },
            populateDropdowns() {
                const productSelect = document.getElementById('product-selector');
                productSelect.innerHTML = '<option value="">-- Pilih Item dari Daftar --</option>';
                this.state.products.forEach(p => productSelect.innerHTML += `<option value="${p.id}">${p.name}</option>`);
                const marketingSelect = document.getElementById('marketing-id');
                marketingSelect.innerHTML = '<option value="">-- Pilih Marketing --</option>';
                this.db.marketing.forEach(m => marketingSelect.innerHTML += `<option value="${m.id}">${m.name}</option>`);
            },
            renderQuotationList() {
                const listEl = document.getElementById('quotation-list');
                if (this.state.quotations.length === 0) { listEl.innerHTML = `<div class="text-center text-gray-500 py-8"><p class="text-lg">Belum ada penawaran.</p><p>Klik "Buat Penawaran Baru" untuk memulai.</p></div>`; return; }
                listEl.innerHTML = this.state.quotations.sort((a,b) => b.id - a.id).map(q => `<div class="border rounded-lg p-4 flex justify-between items-center bg-gray-50 hover:bg-gray-100 transition-colors"><div><p class="font-bold text-blue-700">${q.number}</p><p class="text-gray-800">${q.customer.name} - ${q.projectName}</p><p class="text-sm text-gray-500">Tanggal: ${this.formatDate(q.date)} | Total: ${this.formatCurrency(q.total)}</p></div><div class="flex gap-2"><button onclick="app.showForm(${q.id})" class="text-blue-600 hover:text-blue-800 font-medium">Edit</button><button onclick="app.deleteQuotation(${q.id})" class="text-red-600 hover:text-red-800 font-medium">Hapus</button></div></div>`).join('');
            },
            renderItems() {
                const itemListEl = document.getElementById('item-list');
                if (this.state.currentQuotationItems.length === 0) { itemListEl.innerHTML = '<p class="text-center text-gray-400 py-4">Belum ada item ditambahkan.</p>';
                } else { itemListEl.innerHTML = this.state.currentQuotationItems.map((item, index) => `<div class="grid grid-cols-12 gap-3 items-start p-2 rounded-md bg-gray-50"><div class="col-span-12 md:col-span-4"><p class="font-semibold">${item.name}</p><p class="text-xs text-gray-500 whitespace-pre-wrap">${item.description}</p></div><div class="col-span-6 md:col-span-2"><label class="text-sm text-gray-500">Volume</label><input type="text" inputmode="decimal" value="${item.volume}" oninput="app.updateItemLive(this, ${index}, 'volume')" class="w-full p-1 border rounded-md"></div><div class="col-span-6 md:col-span-1 text-center"><p class="text-sm text-gray-500 mt-6">${item.unit}</p></div><div class="col-span-6 md:col-span-2"><label class="text-sm text-gray-500">Harga Satuan (Rp)</label><input type="text" inputmode="decimal" value="${this.formatCurrencyForInput(item.price)}" oninput="app.updateItemLive(this, ${index}, 'price')" class="w-full p-1 border rounded-md"></div><div class="col-span-5 md:col-span-2 text-right"><p class="text-sm text-gray-500">Jumlah</p><p id="item-total-${index}" class="font-semibold">${this.formatCurrency(item.total)}</p></div><div class="col-span-1 text-right"><button type="button" onclick="app.removeItem(${index})" class="text-red-500 hover:text-red-700 p-2 mt-4 font-bold text-lg">&times;</button></div></div>`).join(''); }
                this.calculateTotal();
            },
            addItem() { const id = document.getElementById('product-selector').value; if (!id) return; const p = this.state.products.find(p => p.id == id); if (p) { this.state.currentQuotationItems.push({ ...p, volume: 1, total: p.price }); this.renderItems(); } document.getElementById('product-selector').value = ''; },
            removeItem(index) { this.state.currentQuotationItems.splice(index, 1); this.renderItems(); },
            updateItemLive(el, index, field) { const item = this.state.currentQuotationItems[index]; if (!item) return; let numVal = (field === 'price') ? this.unformatCurrency(el.value) : (parseFloat(el.value.replace(/,/g,'.')) || 0); if (field === 'price') el.value = this.formatCurrencyForInput(numVal); item[field] = numVal; item.total = (item.volume || 0) * (item.price || 0); document.getElementById(`item-total-${index}`).innerText = this.formatCurrency(item.total); this.calculateTotal(); },
            calculateTotal() { const total = this.state.currentQuotationItems.reduce((sum, item) => sum + (item.total || 0), 0); document.getElementById('total-amount').innerText = this.formatCurrency(total); return total; },
            saveQuotation(showList = true) {
                const customerData = { name: document.getElementById('customer-name').value.trim(), address: document.getElementById('customer-address').value.trim(), phone: document.getElementById('customer-phone').value.trim() };
                const marketingId = document.getElementById('marketing-id').value;
                if (!customerData.name) { this.showToast("Nama pelanggan harus diisi.", "error"); return null; }
                if (!marketingId) { this.showToast("Marketing harus dipilih.", "error"); return null; }
                const id = document.getElementById('quotation-id').value;
                let data = { customer: customerData, marketingId: parseInt(marketingId), projectName: document.getElementById('project-name').value, date: document.getElementById('quotation-date').value, number: document.getElementById('quotation-number').value, validUntil: document.getElementById('valid-until-date').value, items: this.state.currentQuotationItems, conditions: document.getElementById('conditions').value, paymentMethod: document.getElementById('payment-method').value, total: this.calculateTotal(), showTotal: document.getElementById('show-total').checked };
                if (id) { const i = this.state.quotations.findIndex(q => q.id == id); if (i > -1) { this.state.quotations[i] = { ...this.state.quotations[i], ...data }; data.id = parseInt(id); }
                } else { data.id = Date.now(); this.state.quotations.push(data); }
                this.saveToLocalStorage();
                if(showList) this.showList();
                return data;
            },
            deleteQuotation(id) { if(confirm('Yakin ingin menghapus penawaran ini?')) { this.state.quotations = this.state.quotations.filter(q => q.id !== id); this.saveToLocalStorage(); this.renderQuotationList(); } },
            showCustomItemModal(id = null) {
                const title = document.getElementById('custom-item-title');
                document.getElementById('custom-item-id').value = id || '';
                if (id) {
                    title.textContent = 'Edit Item';
                    const product = this.state.products.find(p => p.id === id);
                    if (product) {
                        document.getElementById('custom-item-name').value = product.name;
                        document.getElementById('custom-item-desc').value = product.description;
                        document.getElementById('custom-item-unit').value = product.unit;
                        document.getElementById('custom-item-price').value = product.price;
                    }
                } else {
                    title.textContent = 'Tambah Item Kustom';
                    document.getElementById('custom-item-name').value = '';
                    document.getElementById('custom-item-desc').value = '';
                    document.getElementById('custom-item-unit').value = '';
                    document.getElementById('custom-item-price').value = '';
                }
                document.getElementById('custom-item-modal').classList.add('active');
            },
            addOrUpdateCustomItem() {
                const name = document.getElementById('custom-item-name').value.trim();
                const price = parseFloat(document.getElementById('custom-item-price').value) || 0;
                if (!name || price <= 0) { this.showToast('Nama dan harga item harus valid.', 'error'); return; }
                const id = document.getElementById('custom-item-id').value;
                if (id) { // Update existing product
                    const product = this.state.products.find(p => p.id == id);
                    if (product) {
                        product.name = name;
                        product.description = document.getElementById('custom-item-desc').value.trim();
                        product.unit = document.getElementById('custom-item-unit').value.trim() || 'unit';
                        product.price = price;
                        this.showToast(`Item "${name}" diperbarui.`);
                    }
                } else { // Add new product
                    const newProduct = { id: Date.now(), name, description: document.getElementById('custom-item-desc').value.trim(), unit: document.getElementById('custom-item-unit').value.trim() || 'unit', price };
                    this.state.products.push(newProduct);
                    this.state.currentQuotationItems.push({ ...newProduct, volume: 1, total: price });
                    this.renderItems();
                    this.showToast(`Item kustom "${name}" ditambahkan.`);
                }
                this.saveToLocalStorage();
                this.populateDropdowns();
                if (document.getElementById('product-manager-modal').classList.contains('active')) { this.renderProductManager(); }
                document.getElementById('custom-item-modal').classList.remove('active');
            },
            showProductManager() { this.renderProductManager(); document.getElementById('product-manager-modal').classList.add('active'); },
            renderProductManager() {
                const listEl = document.getElementById('product-manager-list');
                listEl.innerHTML = this.state.products.map(p => `<div class="flex justify-between items-center p-2 border rounded-md"><span>${p.name}</span><div><button onclick="app.showCustomItemModal(${p.id})" class="text-sm text-blue-600 hover:underline mr-2">Edit</button><button onclick="app.deleteProduct(${p.id})" class="text-sm text-red-600 hover:underline">Hapus</button></div></div>`).join('');
            },
            deleteProduct(id) { if (confirm('Yakin ingin menghapus item ini dari daftar?')) { this.state.products = this.state.products.filter(p => p.id !== id); this.saveToLocalStorage(); this.populateDropdowns(); this.renderProductManager(); this.showToast('Item dihapus dari daftar.'); } },
            generateQuotationNumber() { const d = new Date(), y = d.getFullYear(); if (this.state.quotations.length === 0) return `228/MRP/PWRN/${this.toRoman(d.getMonth() + 1)}/${y}`; const lastQ = this.state.quotations.sort((a,b) => b.id - a.id)[0]; const lastN = parseInt(lastQ.number.split('/')[0]) || 227; return `${lastN + 1}/MRP/PWRN/${this.toRoman(d.getMonth() + 1)}/${y}`; },
            toRoman(num) { const r = {M:1000,CM:900,D:500,CD:400,C:100,XC:90,L:50,XL:40,X:10,IX:9,V:5,IV:4,I:1}; let str = ''; for (let i of Object.keys(r)) { let q = Math.floor(num / r[i]); num -= q * r[i]; str += i.repeat(q); } return str; },
            formatCurrency: (amount) => new Intl.NumberFormat('id-ID', { style: 'currency', currency: 'IDR', minimumFractionDigits: 0 }).format(amount || 0),
            formatCurrencyForInput: (value) => (value === null || value === undefined) ? '' : new Intl.NumberFormat('id-ID').format(value),
            unformatCurrency: (value) => parseFloat(String(value).replace(/[^0-9]/g, '')) || 0,
            formatDate(dStr) { if (!dStr) return ''; const d = new Date(dStr + 'T00:00:00'); return new Intl.DateTimeFormat('id-ID', { day: 'numeric', month: 'long', year: 'numeric' }).format(d); },
            saveToLocalStorage() { localStorage.setItem('quotationAppData', JSON.stringify({ quotations: this.state.quotations, products: this.state.products })); },
            loadFromLocalStorage() { const d = localStorage.getItem('quotationAppData'); if (d) { const p = JSON.parse(d); this.state.quotations = p.quotations || []; this.state.products = p.products || [...this.db.initialProducts]; } else { this.state.products = [...this.db.initialProducts]; } },
            showToast(message, type = 'success') {
                const toast = document.getElementById('toast-notification');
                messageEl = document.getElementById('toast-message');
                messageEl.textContent = message;
                toast.className = toast.className.replace(/bg-gray-800|bg-red-600/g, '');
                toast.classList.add(type === 'error' ? 'bg-red-600' : 'bg-gray-800');
                toast.classList.add('show');
                setTimeout(() => { toast.classList.remove('show'); }, 3000);
            },
            showPDFPreview() { const q = this.saveQuotation(false); if (q) { this.generateAndPaginateContent(q); document.getElementById('pdf-preview-modal').classList.add('active'); } },
            createNewPage() { const page = document.createElement('div'); page.className = 'page'; page.innerHTML = `<img class="page-header-img" src="https://raw.githack.com/krisandi89/penawaranmrp/main/kop%20surat%20multibangun.png" alt="Kop Surat"><div class="page-content-wrapper"><div class="page-content-inner"></div></div>`; document.getElementById('preview-container').appendChild(page); return page.querySelector('.page-content-inner'); },
            generateAndPaginateContent(quotation) {
                const previewContainer = document.getElementById('preview-container');
                previewContainer.innerHTML = '';
                let currentContentContainer = this.createNewPage();
                const allContentElements = this.buildAllContentElements(quotation);
                for (const el of allContentElements) {
                    currentContentContainer.appendChild(el);
                    if (currentContentContainer.parentElement.parentElement.scrollHeight > currentContentContainer.parentElement.parentElement.offsetHeight) {
                        el.remove();
                        currentContentContainer = this.createNewPage();
                        currentContentContainer.appendChild(el);
                        if (el.tagName === 'TABLE') { const header = el.querySelector('thead'); if(header) { const newTable = currentContentContainer.querySelector('table'); if(newTable) newTable.prepend(header.cloneNode(true)); } }
                    }
                }
            },
            buildAllContentElements(quotation) {
                const fragment = document.createDocumentFragment();
                const customer = quotation.customer;
                const marketingPerson = this.db.marketing.find(m => m.id == quotation.marketingId);
                
                const headerContainer = document.createElement('div');
                headerContainer.style.display = 'flex';
                headerContainer.style.justifyContent = 'space-between';
                headerContainer.innerHTML = `<div>No. <span style="font-weight: bold;">${quotation.number}</span><br>Jakarta, ${this.formatDate(quotation.date)}</div>`;
                fragment.appendChild(headerContainer);

                const clientSection = document.createElement('section');
                clientSection.style.marginTop = '2rem';
                clientSection.innerHTML = `<p>Kepada Yth.:</p><p style="font-weight: bold; text-transform: uppercase;">${customer.name}</p><div style="white-space: pre-wrap;">${customer.address}</div><br><p>Telepon: <span style="font-weight: 600;">${customer.phone}</span></p>`;
                fragment.appendChild(clientSection);

                const subjectSection = document.createElement('section'); subjectSection.style.cssText = 'margin: 1.5rem 0;'; subjectSection.innerHTML = `<p style="font-weight: bold; text-decoration: underline;">Perihal: <span>Penawaran Harga</span></p><p>Proyek: <span>${quotation.projectName}</span></p>`; fragment.appendChild(subjectSection);
                const openingSection = document.createElement('section'); openingSection.style.marginBottom = '1.5rem'; openingSection.innerHTML = `<p>Dengan hormat,</p><p>Menindaklanjuti permohonan penawaran harga resmi kami untuk proyek tersebut, maka bersama ini saya kirimkan harga produk kami sebagai berikut:</p>`; fragment.appendChild(openingSection);
                
                const table = document.createElement('table');
                let tableHTML = `<thead><tr><th style="width: 45%;">Material</th><th>Volume</th><th>Harga</th><th>Jumlah Harga</th></tr></thead><tbody>`;
                quotation.items.forEach(item => {
                    const desc = item.description.replace(/Merk:/g, '<span style="font-weight:bold">Merk:</span>');
                    tableHTML += `<tr><td><div style="font-weight: bold;">${item.name}</div><div style="font-size: 8pt; white-space: pre-wrap;">${desc}</div></td><td style="text-align: center;">${this.formatCurrencyForInput(item.volume)} ${item.unit}</td><td style="text-align: right;">${this.formatCurrency(item.price)}</td><td style="text-align: right;">${this.formatCurrency(item.total)}</td></tr>`;
                });
                if (quotation.showTotal) {
                    tableHTML += `<tr><td colspan="3" style="text-align: right; font-weight: bold;">Total</td><td style="text-align: right; font-weight: bold;">${this.formatCurrency(quotation.total)}</td></tr>`;
                }
                table.innerHTML = tableHTML + '</tbody>'; fragment.appendChild(table);

                const createSection = (title, content) => { const s = document.createElement('section'); s.style.marginTop = '1.5rem'; s.innerHTML = `<h4 style="font-weight: bold;">${title}</h4><div style="padding-left: 1rem; white-space: pre-wrap; font-size: 9pt;">${content}</div>`; return s; };
                fragment.appendChild(createSection('Kondisi Penawaran :', quotation.conditions)); fragment.appendChild(createSection('Metode Pembayaran :', quotation.paymentMethod));
                const closingSection = document.createElement('section'); closingSection.style.marginTop = '1.5rem'; closingSection.innerHTML = `<p>Penawaran harga ini berlaku sampai dengan tanggal <span style="font-weight: bold;">${this.formatDate(quotation.validUntil)}</span>.</p><br><p>Demikian penawaran harga ini kami sampaikan. Atas perhatian dan kerjasamanya kami ucapkan terima kasih.</p>`; fragment.appendChild(closingSection);
                if (marketingPerson) { const sigSection = document.createElement('footer'); sigSection.style.marginTop = '2rem'; sigSection.innerHTML = `<p>Hormat kami,</p><div style="height: 6rem; position: relative;"><img src="${marketingPerson.signatureImg}" alt="Tanda Tangan" style="height: 6rem;"></div><p style="font-weight: bold;">${marketingPerson.name}</p><p style="font-style: italic;">${marketingPerson.title}</p><p>${marketingPerson.phone}</p>`; fragment.appendChild(sigSection); }
                return Array.from(fragment.children);
            },
            downloadPDF() { const el = document.getElementById('preview-container'); const q = this.saveQuotation(false); const opt = { margin: 0, filename: `${q.number.replace(/\//g, '-')}.pdf`, image: { type: 'jpeg', quality: 0.98 }, html2canvas: { scale: 2, useCORS: true }, jsPDF: { unit: 'cm', format: 'a4', orientation: 'portrait' } }; html2pdf().from(el).set(opt).save(); }
        };
        document.addEventListener('DOMContentLoaded', () => { app.init(); });
    </script>
</body>
</html>

